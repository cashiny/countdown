<h1>Create a Countdown</h1>
<div id="imagePreviewContainer" style="margin-bottom: 1rem; display: none;">
    <img id="imagePreview" alt="Selected Image" style="max-width: 100%; max-height: 200px; border: 1px solid #ccc; border-radius: 0.5rem;" />
</div>
<form id="createForm">
    <label>Pick end date
        <input type="date" id="date" required />
    </label>

    <label>Pick end time (24-hour)
        <input type="time" id="time" step="60" required />
    </label>

    <label>Message (optional)
        <input type="text" id="message" maxlength="100" placeholder="Reason for countdown" />
    </label>

    <label>Select an image (optional)
        <input type="file" id="imageInput" accept="image/*" />
    </label>

    <button type="submit">Start Countdown</button>
</form>

<script>
    document.getElementById('imageInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = event.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }
    });

    document.getElementById('createForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const dateVal = document.getElementById('date').value; // YYYY-MM-DD
        const timeVal = document.getElementById('time').value; // HH:MM[:ss]
        if (!dateVal || !timeVal) {
            alert('Please select both a date and a time.');
            return;
        }

        // Compose local date-time string without timezone
        let endString = `${dateVal}T${timeVal}`;
        if (!/\d{2}:\d{2}:\d{2}$/.test(timeVal)) {
            endString += ':00'; // add seconds if missing
        }

        const msgVal = document.getElementById('message').value.trim();
        const imageInput = document.getElementById('imageInput').files[0];
        let imageUrl = '';

        if (imageInput) {
            const reader = new FileReader();
            reader.onload = function (event) {
                imageUrl = event.target.result;

                // Construct the URL to the existing countdown page
                let url = `countdown.html?end=${encodeURIComponent(endString)}`;
                if (msgVal) {
                    url += `&p=${encodeURIComponent(msgVal)}`;
                }
                url += `&img=${encodeURIComponent(imageUrl)}`;

                // Redirect
                window.location.href = url;
            };
            reader.readAsDataURL(imageInput);
        } else {
            // Construct the URL to the existing countdown page
            let url = `countdown.html?end=${encodeURIComponent(endString)}`;
            if (msgVal) {
                url += `&p=${encodeURIComponent(msgVal)}`;
            }

            // Redirect
            window.location.href = url;
        }
    });
</script>